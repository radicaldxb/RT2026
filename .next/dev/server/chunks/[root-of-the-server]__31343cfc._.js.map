{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/stephanvanwijk/Library/CloudStorage/Dropbox/Radical%20Thinking/RT%20Website/2026/RT2026/src/app/api/chatbot/route.js"],"sourcesContent":["// src/app/api/chatbot/route.js\nconst rateLimit = new Map();\n\nexport async function POST(req) {\n  try {\n    // Rate Limiting\n    let ip = req.headers.get(\"x-forwarded-for\")?.split(',')[0]?.trim();\n    if (!ip) ip = req.headers.get(\"x-real-ip\")?.trim();\n    if (!ip) ip = \"unknown\";\n    const limit = 40; // requests\n    const windowMs = 60 * 1000; // 1 minute\n\n    if (!rateLimit.has(ip)) {\n      rateLimit.set(ip, {\n        count: 0,\n        lastReset: Date.now(),\n      });\n    }\n\n    const ipData = rateLimit.get(ip);\n\n    if (Date.now() - ipData.lastReset > windowMs) {\n      ipData.count = 0;\n      ipData.lastReset = Date.now();\n    }\n\n    if (ipData.count >= limit) {\n      console.warn(`[API] Rate limit hit for IP: ${ip}`);\n      return new Response(\n        JSON.stringify({ error: \"Too many requests. Please try again later.\" }),\n        {\n          status: 429,\n          headers: { \"Content-Type\": \"application/json\" },\n        }\n      );\n    }\n\n    ipData.count += 1;\n\n    const body = await req.json();\n    const chatInput = body.chatInput;\n    const sessionId = body.sessionId || \"test-123\"; // default session\n    const metadata = body.metadata || {};\n\n    //  Validate chatInput\n    if (!chatInput || typeof chatInput !== \"string\") {\n      console.error(\"Invalid chatInput in request body:\", body);\n      return new Response(\n        JSON.stringify({ error: \"chatInput must be a non-empty string\" }),\n        {\n          status: 400,\n          headers: { \"Content-Type\": \"application/json\" },\n        }\n      );\n    }\n\n    if (chatInput.length > 500) {\n      return new Response(\n        JSON.stringify({ reply: \"Message is too long. Please limit it to 500 characters.\" }),\n        {\n          status: 200,\n          headers: { \"Content-Type\": \"application/json\" },\n        }\n      );\n    }\n\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\"Received chatInput:\", chatInput);\n      console.log(\"Received sessionId:\", sessionId);\n    }\n\n    // --- call n8n webhook ---\n    const webhookUrl = process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL;\n    if (!webhookUrl) {\n      console.error(\"‚ùå Missing NEXT_PUBLIC_N8N_WEBHOOK_URL environment variable\");\n      return new Response(\n        JSON.stringify({ error: \"Server configuration error: Missing Webhook URL\" }),\n        { status: 500, headers: { \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const n8nRes = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ chatInput, sessionId, metadata }),\n    });\n\n    const rawText = await n8nRes.text();\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\"üì® n8n raw response:\", rawText);\n    }\n\n    let data;\n    try {\n      const parsed = JSON.parse(rawText);\n      // Handle n8n returning an array (common behavior) or object\n      const item = Array.isArray(parsed) ? (parsed[0] || {}) : (parsed || {});\n\n      // Normalize to a single 'reply' field by checking common keys\n      let reply = item.output || item.reply || item.text || item.message || item.content;\n\n      // Ensure reply is a string to prevent client rendering errors\n      if (typeof reply === 'object' && reply !== null) {\n        reply = JSON.stringify(reply);\n      } else if (reply === undefined || reply === null) {\n        reply = typeof item === 'string' ? item : JSON.stringify(item);\n      }\n      data = { reply: String(reply) };\n    } catch {\n      console.warn(\"n8n did not return valid JSON, sending raw text back\");\n      data = { reply: rawText || \" No response from n8n\" };\n    }\n\n    return new Response(JSON.stringify(data), {\n      status: n8nRes.ok ? 200 : 502, // 502 for bad gateway if n8n fails\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  } catch (error) {\n    console.error(\"API route crashed:\", error);\n    return new Response(\n      JSON.stringify({\n        error: (error && error.message) || \"Internal Server Error\",\n      }),\n      {\n        status: 500,\n        headers: { \"Content-Type\": \"application/json\" },\n      }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}